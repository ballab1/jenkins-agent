
//################################################################################
//# Copyright (c) 2017-2023 Dell Inc. or its subsidiaries.  All rights reserved.
//################################################################################

import groovy.transform.Field

@Library(['jenkins-global-lib@main']) _


// Initialize here so it is still available in post block if build fails.
@Field String TOPIC = 'techops-jenkins-events'


pipeline {
    agent {
        kubernetes {
            defaultContainer 'jnlp'
            yamlFile 'ci/unittest-pipeline.yaml'
            showRawYaml(false)
        }
    }

    environment {
        UNIT_TESTS = 1
        DEBUG = 0
        GIT_LFS_SKIP_SMUDGE = 1
        VERSION = 'v1beta'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        ansiColor('xterm')
    }

    stages {
         stage ('Report Build Start') {
            steps {
                reportBuildStart(script: this, topic: TOPIC)
            }
         }
        stage('Unit Tests') {
            when { environment name: 'UNIT_TESTS', value: '1' }
            steps {
                container(name: 'builder') {
                    sh 'python3 -m pytest --verbose --junit-xml reports/unit_tests.xml'
                    archiveArtifacts allowEmptyArchive: true, artifacts: 'reports/unit_tests.xml'
                }
            }
        }
    }
    post {
        always {
            reportBuildResult(script: this, topic: TOPIC)
            drp_SendEmail()
        }
    }
}
