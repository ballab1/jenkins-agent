@Library('jenkins-sharedlibs')_

def props = null;
def image = null;

pipeline {
    agent { label 's3.ubuntu.home' }

    environment {
        DOCKER_CREDENTIALS_ID = '1a69cdbb-be20-4bde-b30a-87ef9b2db969'
    }

    stages {
        stage('Setup environment') {
            steps {
                script {
                    props = myProperties()
                }
            }
        }

        stage('Build Image') {
            steps {
                script {
                    echo "DOCKER_REGISTRY: ${props['DOCKER_REGISTRY']},  DOCKER_IMAGE: ${props['TARGET']}"
                    image = docker.build("${props['TARGET']}", '.')
                }
            }
        }

        stage('Push Image') {
            steps {
                script {
                    docker.withRegistry("https://${props['DOCKER_REGISTRY']}", "${DOCKER_CREDENTIALS_ID}") {
                        image.push()
                    }
                }
            }
        }
    }

    post {
        always {
            kafkaBuildReporter()
        }
        cleanup {
            deleteDir()
        }
    }
}
