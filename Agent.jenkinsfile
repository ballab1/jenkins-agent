@Library('jenkins-sharedlibs')_

pipeline {
    agent { label 's3.ubuntu.home' }

    environment {
        DOCKER_IMAGE = 'registry.ubuntu.home/alpine/jenkins/inbound-agent/3345.v03dee9b_f88fc-1-alpine-jdk21'
        DOCKER_REGISTRY = 'registry.ubuntu.home'  // e.g., index.docker.io or registry.example.com
        DOCKER_CREDENTIALS_ID = '1a69cdbb-be20-4bde-b30a-87ef9b2db969'
    }

    stages {
        stage('Build Image') {
            steps {
                script {
                    env.DOCKER_TAG = gitTag()
                    docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}", '.')
                }
            }
        }

        stage('Push Image') {
            steps {
                script {
                    docker.withRegistry("https://${DOCKER_REGISTRY}", "${DOCKER_CREDENTIALS_ID}") {
                        docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push()
                    }
                }
            }
        }
    }

    post {
        always {
            kafkaBuildReporter()
        }
        cleanup {
            deleteDir()
        }
    }
}
